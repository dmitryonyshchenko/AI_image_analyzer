{% extends "base.html" %}
{% block title %}{{ scenario.name }} â€” Result{% endblock %}

{% block content %}
<header class="site-header">
    <h1>ğŸ” {{ scenario.name }}</h1>
</header>

<div class="card">

    <!-- Annotated (or original) image, embedded as base64 â€” no server files kept -->
    {% if show_image and image_b64 %}
    <div class="result-image-wrap">
        <img src="data:image/{{ img_mime }};base64,{{ image_b64 }}"
             alt="Annotated image" class="result-image">
    </div>
    {% endif %}

    <!-- Share section -->
    <div class="share-section">
        <button class="btn-share" onclick="shareResult()">ğŸ“¤ Share result</button>
        <div class="share-links">
            <span class="share-label">or:</span>
            <a class="share-btn" href="#" onclick="shareOn('telegram');  return false;">Telegram</a>
            <a class="share-btn" href="#" onclick="shareOn('twitter');   return false;">ğ• Twitter</a>
            <a class="share-btn" href="#" onclick="shareOn('whatsapp');  return false;">WhatsApp</a>
            <a class="share-btn" id="btn-copy" href="#" onclick="copyResult(); return false;">ğŸ“‹ Copy text</a>
        </div>
    </div>

    <!-- Optional constant text (e.g. ruler joke, disclaimers) -->
    {% if scenario.constant_text %}
    <div class="constant-text">{{ scenario.constant_text }}</div>
    {% endif %}

    <!-- Result table -->
    {% if scenario.show_result_table and result_table %}
    <table class="result-table">
        {% for row in result_table %}
        <tr class="{{ 'metadata-row' if row.type == 'metadata' else '' }}">
            <td class="rt-field">{{ row.field }}</td>
            <td class="rt-value">
                {%- if row.type == 'link' and row.value and row.value != 'â€”' -%}
                    <a href="{{ row.value }}" target="_blank" rel="noopener noreferrer">{{ row.value }}</a>
                {%- else -%}
                    {{ row.value }}
                {%- endif -%}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    <a href="/" class="btn-back">â† Analyze another image</a>
</div>
{% endblock %}

{% block scripts %}
<script>
const SCENARIO_NAME = {{ scenario.name | tojson }};
const SITE_URL      = {{ site.footer_demo_url | tojson }};
const IMAGE_B64     = {{ image_b64 | tojson if image_b64 else 'null' }};
const IMG_MIME      = {{ img_mime | tojson }};
const RESULT_ROWS   = {{ result_table | tojson if result_table else '[]' }};

function buildText() {
    const lines = [`ğŸ” ${SCENARIO_NAME} â€” AI Image Analyzer`, ''];
    RESULT_ROWS.forEach(r => {
        if (r.type !== 'link') lines.push(`${r.field}: ${r.value}`);
    });
    lines.push('', `Analyzed for free at: ${SITE_URL}`);
    return lines.join('\n');
}

function base64ToFile(b64, mime) {
    const binary = atob(b64);
    const arr = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);
    return new File([arr], `ai_result.${mime}`, { type: `image/${mime}` });
}

async function shareResult() {
    const text = buildText();
    const shareData = { title: `${SCENARIO_NAME} â€” AI Image Analyzer`, text, url: SITE_URL };

    if (IMAGE_B64) {
        try {
            const file = base64ToFile(IMAGE_B64, IMG_MIME);
            if (navigator.canShare && navigator.canShare({ files: [file] }))
                shareData.files = [file];
        } catch(e) {}
    }

    if (navigator.share) {
        try { await navigator.share(shareData); return; } catch(e) {
            if (e.name === 'AbortError') return;
        }
    }
    // Fallback: copy text to clipboard
    copyResult();
}

function shareOn(network) {
    const url  = encodeURIComponent(SITE_URL);
    const text = encodeURIComponent(buildText());
    const links = {
        twitter:  `https://twitter.com/intent/tweet?url=${url}&text=${text}`,
        telegram: `https://t.me/share/url?url=${url}&text=${text}`,
        whatsapp: `https://wa.me/?text=${text}%20${url}`,
    };
    window.open(links[network], '_blank', 'width=620,height=450,noopener');
}

function copyResult() {
    const btn = document.getElementById('btn-copy');
    navigator.clipboard.writeText(buildText()).then(() => {
        btn.textContent = 'âœ… Copied!';
        setTimeout(() => btn.textContent = 'ğŸ“‹ Copy text', 2000);
    });
}
</script>
{% endblock %}
